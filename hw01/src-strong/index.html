<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HW01 Strong baseline (4pt)</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>
    @font-face {
        font-family:'CircleFont'; /* src: url(https://circle472.github.io/ct2022s/hw04/CircleFont.ttf);  https://github.com/circle472/ct2022s/ */
        src: url(CircleFont_v2.woff2); /* https://cloudconvert.com/ttf-to-woff2 */
    }
    body {
        background-color: rgba(255, 128, 255, 0.1);
        font-family: 'CircleFont', 'Noto Serif JP', serif;
    }
    h3 {
        background-color: rgba(255, 255, 0, 0.1);
        color: white; 
        text-shadow: 0 0 6px #FF0000, 0 0 6px #000000;
        font-family: 'CircleFont', 'Noto Serif JP', serif;
        font-size: 18pt;
        border: solid 1px black;
        width: 90%;
        margin: 5px auto;
        padding: 10px;
        text-align: center;
    }
    div {
        background-color: rgba(255, 255, 0, 0.1);
        font-family: 'CircleFont', 'Noto Serif JP', serif;
        font-size: 16pt;
        border: solid 1px black;
        width: 90%;
        margin: 5px auto;
        padding: 10px;
        text-align: center;
    }
    </style>
</head>
<body>
    <h3>Data Visualization 成績</h3>
    <div id="chart-container"></div>
    <script type="text/javascript" charset="utf-8">

    async function createRadialStackedBarChart() {
      try {
        const response = await fetch('data.csv');
        if (!response.ok) {
          throw new Error('Failed to fetch data.csv');
        }

        const csvData = await response.text();
        const data = d3.csvParse(csvData);

        if (data && data.columns) {
          const keys = data.columns.slice(1);
          const dataset = keys.map(hw => ({
            name: hw,
            values: data.map(d => ({ name: d.Name, value: +d[hw] }))
          }));

          const width = 928;
          const height = width;
          const innerRadius = 180;
          const outerRadius = Math.min(width, height) / 2;

          const svg = d3.select("#chart-container")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", `translate(${width / 2},${height / 2})`);

            // 將資料堆疊成系列，每個系列代表一個特定的作業
          const stack = d3.stack()
            .keys(keys)
            .order(d3.stackOrderNone)
            .offset(d3.stackOffsetNone);

          const series = stack(dataset);

          const color = d3.scaleOrdinal(d3.schemeCategory10);

          // 创建一个mouseover事件处理函数
        function MouseOver(d, i) {
            // d 是数据对象，i 是数据的索引
            // 在此处执行悬停时的操作，例如更改颜色或显示信息
            d3.select(this).attr("fill", "red");
        }
        function MouseOut(d, i) {
            // d 是数据对象，i 是数据的索引
            // 在此处执行悬停时的操作，例如更改颜色或显示信息
            d3.select(this).attr("fill", color(d.key)); // 恢复原始颜色
        }

          const pathSelection = svg.selectAll("g")
            .data(series)
            .enter().append("g")
            .attr("fill", d => color(d.key))
            .selectAll("path")
            .data(d => d)
            .enter().append("path")
            .attr("d", d3.arc()
              .innerRadius(d => innerRadius + (d[0] / 60) * (outerRadius - innerRadius))
              .outerRadius(d => innerRadius + (d[1] / 60) * (outerRadius - innerRadius))
              .startAngle(d => d.data.name / 120 * 2 * Math.PI)
              .endAngle(d => (d.data.name + 1) / 120 * 2 * Math.PI)
            )

            console.log("pathSelection:", pathSelection);
            // 检查是否成功选择了路径元素，然后添加事件处理程序
            if (pathSelection) {
                pathSelection.on("mouseover", MouseOver)
                .on("mouseout", MouseOut);
            }
        }
        else {
          console.error('Error: Data is undefined or does not have columns.');
        }
      } catch (error) {
        console.error('Error: ' + error);
      }
    }

    createRadialStackedBarChart();
    </script>
</body>
</html>